# Sportmonks Data Fetching - Root Cause & Fix

## Problem Identified

**Issue**: No Sportmonks player data was being fetched, even though the API client code was correct and the API key was configured.

**Root Cause**: The background job that fetches Sportmonks data (`/api/inbound/process-pending`) was never being triggered.

## How the System Should Work

1. **WhatsApp Webhook** receives a Transfermarkt URL
   - Creates `inbound_target` with status `RECEIVED`
   - Responds immediately to WhatsApp

2. **Background Job** (`/api/inbound/process-pending`) runs every minute
   - Picks up targets with status `RECEIVED`
   - Parses Transfermarkt URL to extract player name
   - Searches Sportmonks API for matching players
   - Updates status to `READY_FOR_FETCH` with Sportmonks player ID
   - Fetches full player data from Sportmonks
   - Saves to `players` table
   - Updates `inbound_target` status to `READY`

3. **Dashboard** displays targets with fit scores

## What Was Missing

The background job endpoint existed, but there was **no automatic trigger**. The system was waiting for targets to be processed, but nothing was calling the processing endpoint.

## Solution Implemented

### 1. Created Vercel Cron Configuration (`vercel.json`)

```json
{
  "crons": [
    {
      "path": "/api/inbound/process-pending",
      "schedule": "* * * * *"
    }
  ]
}
```

This tells Vercel to call the endpoint every minute (standard cron syntax).

### 2. Updated Authentication Logic

Modified `/src/app/api/inbound/process-pending/route.ts` to accept three authentication methods:

1. **Vercel Cron** (production): `Authorization: Bearer ${CRON_SECRET}`
2. **Manual header** (testing): `x-skoutex-secret: ${INTERNAL_JOB_SECRET}`
3. **Query parameter** (browser testing): `?secret=${INTERNAL_JOB_SECRET}`

### 3. Added GET Handler

The endpoint now supports both GET and POST requests, making it easier to test manually by visiting the URL in a browser:

```
http://localhost:3000/api/inbound/process-pending?secret=YOUR_SECRET
```

## How to Test Locally

Since Vercel Cron only works in production, you need to manually trigger the job locally:

### Option 1: Browser
Visit: `http://localhost:3000/api/inbound/process-pending?secret=YOUR_INTERNAL_JOB_SECRET`

### Option 2: cURL
```bash
curl -X POST http://localhost:3000/api/inbound/process-pending \
  -H "x-skoutex-secret: YOUR_INTERNAL_JOB_SECRET"
```

### Option 3: Create a Test Script

Create a simple Node.js script that calls the endpoint every 10 seconds while developing:

```javascript
// test-cron.js
const secret = process.env.INTERNAL_JOB_SECRET;
const url = `http://localhost:3000/api/inbound/process-pending?secret=${secret}`;

setInterval(async () => {
  console.log(`[${new Date().toISOString()}] Triggering process-pending...`);
  try {
    const response = await fetch(url, { method: 'POST' });
    const data = await response.json();
    console.log('Result:', data);
  } catch (error) {
    console.error('Error:', error.message);
  }
}, 10000); // Every 10 seconds

console.log('Cron simulator running. Press Ctrl+C to stop.');
```

Run with:
```bash
node test-cron.js
```

## Environment Variables Required

Update `.env.local`:

```bash
# Existing
SPORTMONKS_API_KEY=HovUUXdokVEI5queVzXelTVBkP5urQcDceUSuQtwstmemclfQ7u0zBWRjyL3

# Add if missing
INTERNAL_JOB_SECRET=<generate with: openssl rand -hex 32>

# Vercel adds this automatically in production (no need to set locally)
CRON_SECRET=<auto-generated by Vercel>
```

## Deployment Checklist

### Before Deploying:

1. ✅ `vercel.json` exists with cron configuration
2. ✅ `INTERNAL_JOB_SECRET` is set in Vercel environment variables
3. ✅ `SPORTMONKS_API_KEY` is set in Vercel environment variables
4. ✅ All other required environment variables are set (see PRODUCTION_CHECKLIST.md)

### After Deploying:

1. Check Vercel Dashboard → Cron Jobs → Verify cron is scheduled
2. Check Vercel Dashboard → Environment Variables → Verify `CRON_SECRET` exists
3. Send a test WhatsApp message with a Transfermarkt URL
4. Wait 1 minute for cron to run
5. Check `/inbound-targets` dashboard → Player should appear with status `READY`
6. Click player → Verify Sportmonks data is populated

## Monitoring

Check Vercel Function Logs for:
- Cron execution (should see logs every minute)
- `[whatsapp:webhook]` - Incoming WhatsApp messages
- `[process-pending]` - Background job execution
- `[sportmonks]` - API calls to Sportmonks

Look for these statuses in the `inbound_targets` table:
- `RECEIVED` → Just received, waiting for processing
- `RESOLVING` → Currently parsing Transfermarkt URL
- `NEEDS_CONFIRMATION` → Multiple players found, waiting for user selection
- `READY_FOR_FETCH` → Player ID resolved, ready to fetch from Sportmonks
- `READY` → Player data fetched and saved, ready to display
- `FAILED` → Processing failed (check `last_error` column)

## Expected Behavior After Fix

1. Send Transfermarkt URL via WhatsApp → Immediate acknowledgment
2. Wait 1 minute (cron runs) → Status changes from `RECEIVED` → `RESOLVING` → `READY_FOR_FETCH` → `READY`
3. Dashboard shows player with Sportmonks data populated
4. Fit score calculation works (if club context is complete)

## Files Modified

1. `/vercel.json` - **NEW** - Cron configuration
2. `/src/app/api/inbound/process-pending/route.ts` - Updated authentication logic, added GET handler
3. `/PRODUCTION_CHECKLIST.md` - Added cron job documentation
4. `/SPORTMONKS_FIX.md` - **NEW** - This document

## Still Not Working?

If Sportmonks data still isn't fetching after deploying:

1. **Check Vercel Logs**: Look for cron execution errors
2. **Verify CRON_SECRET**: Vercel Dashboard → Environment Variables
3. **Test API Key**: Use Sportmonks API playground to verify the key works
4. **Check Database**: Query `inbound_targets` to see status progression
5. **Manual Trigger**: Call the endpoint manually to see detailed error messages

```bash
curl -X POST https://your-domain.com/api/inbound/process-pending \
  -H "x-skoutex-secret: YOUR_INTERNAL_JOB_SECRET"
```

## Summary

The fix was simple: **add a cron job to trigger the background processing**. The code was already correct, but it needed something to call it regularly. Now:

- ✅ Vercel Cron calls the endpoint every minute in production
- ✅ Manual triggers work for local development
- ✅ Sportmonks data will be fetched automatically
- ✅ System is fully functional end-to-end
